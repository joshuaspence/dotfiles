#!/bin/bash

#/
## Creates a data URL from a file or from piped input.
##
## @param [optional, String] The path to the file to be encoded. If equal to '-'
##                           or if not is specified, then data is read from
##                           standard input.
#\

#| Usage: dataurl [<file>]
#|
#| Creates a data URL from a file or from piped input.

set -e

function usage() {
    cat "$0" |
    grep '^#|' |
    cut -c4-
}

if [[ $# > 0 && ( "$1" == '-h' || "$1" == '--help' ) ]]; then
    usage
    exit 0
fi

if [[ ( $# == 0 || ( $# > 0 && $1 == '-' ) && ! -p /dev/stdin ]]; then
    usage
    exit 1
fi

mime=$(mimetype -b $(test -p /dev/stdin && echo '--stdin' || echo "$1"))
if [[ $mime == text/* ]]; then
    mime="${mime};charset=utf-8"
fi

echo -n "data:${mime};base64,$(openssl base64 $(test -p /dev/stdin || echo "-in $1") | tr -d '\n')"

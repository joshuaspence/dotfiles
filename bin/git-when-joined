#!/usr/bin/env python
"""
Get date of each committer's first commit (in whole repo or just
for <path>).

Usage:

    git when-joined [<path>]

<path> has to be relative to repo root.

https://github.com/narfdotpl/dotfiles/blob/master/home/.scripts/git/when-joined.py
"""

from git import Git
from pipes import quote
from subprocess import PIPE, Popen
from sys import argv, stderr

__author__ = 'Maciej Konieczny <hello@narf.pl>'


def main():
    # Stop if there's no repo
    Git()

    # Show usage info if there are too many arguments
    if len(argv) > 2:
        print >> stderr, __doc__[1:-1]
        exit(1)

    # Get <path>
    if len(argv) == 2:
        path = quote(argv[1])
    else:
        path = ''

    # Get ready
    accessions = {}  # {'author': 'date'}
    command = 'git log --reverse --pretty=format:"%ad %an" --date=short ' + path

    # Read one commit at a time
    for line in Popen(command, shell=True, stdout=PIPE).stdout:
        split = line.split()
        date = split[0]
        author = ' '.join(split[1:])

        if author not in accessions:
            accessions[author] = date

    # List authors in chronological order
    for author, date in sorted(accessions.iteritems(), key=lambda tpl: tpl[1]):
        print date, author

if __name__ == '__main__':
    main()

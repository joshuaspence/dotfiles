#!/usr/bin/env aptfile

CODENAME=$(lsb_release --codename --short)
DEBIAN_FRONTEND=noninteractive

export DEBIAN_FRONTEND

function apt_repository() {
  local name="$1"
  local apt_repo="$2"
  local architecture="$3"
  local components="$4"
  local gpg_key="$5"

  local apt_opts=()
  test -n "${architecture}" && apt_opts+=("arch=${architecture}")
  apt_opts+=("signed-by=/etc/apt/keyrings/${name}.gpg")

  # Install GPG key.
  if ! test -f "/etc/apt/keyrings/${name}.gpg"; then
    curl --fail --location --show-error --silent "${gpg_key}" | gpg --dearmor --output "/etc/apt/keyrings/${name}.gpg"
  fi

  # Create apt repository.
  repository_file "${name}" "deb [${apt_opts[*]}] ${apt_repo} ${components}"
}

function deb_repo() {
  local name="$1"
  local url="$2"
  local gpg_key="$3"

  local apt_conf="/etc/apt/apt.conf.d/50${name}.conf"
  local apt_repo="/var/lib/apt/repos/${name}"
  local gpg_cmd="true"

  if test -n "${gpg_key}"; then
    if ! test -f "/etc/apt/keyrings/${name}.gpg"; then
      curl --fail --location --show-error --silent "${gpg_key}" | gpg --dearmor --output "/etc/apt/keyrings/${name}.gpg"
      gpg --import "/etc/apt/keyrings/${name}.gpg"
    fi

    gpg_cmd = "dpkg-sig --verify ${apt_repo}/*.deb"
  fi

  if ! test -f "${apt_conf}"; then
    mkdir --parents "${apt_repo}"
    cat << EOF > "${apt_conf}"
APT::Update::Pre-Invoke { "wget --quiet --timestamping --directory-prefix ${apt_repo} ${url}"; };
APT::Update::Pre-Invoke { "${gpg_cmd}"; };
APT::Update::Pre-Invoke { "cd ${apt_repo} && apt-ftparchive packages . > Packages"; };
APT::Update::Pre-Invoke { "cd ${apt_repo} && apt-ftparchive release . > Release"; };
EOF
  fi

  repository_file "${name}" "deb [trusted=yes lang=none] file:${apt_repo} ./"
}

apt_repository "azlux" "http://packages.azlux.fr/debian/" "" "bullseye main" "https://azlux.fr/repo.gpg"
apt_repository "docker" "https://download.docker.com/linux/ubuntu" "amd64" "${CODENAME} stable" "https://download.docker.com/linux/ubuntu/gpg"
apt_repository "dropbox" "https://linux.dropbox.com/ubuntu" "i386,amd64" "disco main" "https://linux.dropbox.com/fedora/rpm-public-key.asc"
apt_repository "github-cli" "https://cli.github.com/packages" "amd64" "stable main" "https://cli.github.com/packages/githubcli-archive-keyring.gpg"
apt_repository "kubernetes" "https://apt.kubernetes.io" "" "kubernetes-xenial main" "https://packages.cloud.google.com/apt/doc/apt-key.gpg"
apt_repository "hashicorp" "https://apt.releases.hashicorp.com" "amd64" "${CODENAME} main" "https://apt.releases.hashicorp.com/gpg"
deb_repo "minikube" "https://github.com/kubernetes/minikube/releases/download/v1.26.0/minikube_1.26.0-0_amd64.deb" ""
apt_repository "slack" "https://packagecloud.io/slacktechnologies/slack/debian/" "" "jessie main" "https://packagecloud.io/slacktechnologies/slack/gpgkey"
apt_repository "speedtest-cli" "https://packagecloud.io/ookla/speedtest-cli/ubuntu/" "" "focal main" "https://packagecloud.io/ookla/speedtest-cli/gpgkey"
apt_repository "vscode" "https://packages.microsoft.com/repos/code" "amd64,arm64,armhf" "stable main" "https://packages.microsoft.com/keys/microsoft.asc"
deb_repo "zoom" "https://zoom.us/client/latest/zoom_amd64.deb" "https://zoom.us/linux/download/pubkey"

update

packagelist "apt-file" "apt-utils" "dpkg-sig" "synaptic"
package "awscli"
package "bat"
package_from_url "bottom" "--location https://github.com/ClementTsang/bottom/releases/download/0.6.8/bottom_0.6.8_amd64.deb"
package "build-essential"
package "code"
package "ctop"
packagelist "curl" "wget"
packagelist "dconf-editor" "libglib2.0-bin"
packagelist "docker-ce" "docker-ce-cli"
package "dog"
package "dropbox"
package "duf"
package "exa"
package "fd-find"
package "flatpak"
package "fzf"
package "gawk"
package "gh"
package "gimp"
packagelist "git" "git-crypt" "git-extras" "git-lfs"
package_from_url "google-chrome-stable" "https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"
package "gpg"
packagelist "htop" "iftop" "powerstat"
packagelist "iputils-ping" "gping"
package "jq"
packagelist "kubectl" "minikube"
package "less"
packagelist "libcairo2-dev" "libgirepository1.0-dev" "python3-gi" # for `pygobject`
package "moreutils"
packagelist "bind9-dnsutils" "netcat-openbsd" "netstat-nat" "whois"
packagelist "network-manager-l2tp" "network-manager-openconnect"
packagelist "nmap" "traceroute"
packagelist "packer" "terraform"
packagelist "parallel" "retry"
packagelist "python3" "python3-dev" "python3-venv"
package "qemu-user-static"
package "ripgrep"
package "slack-desktop"
package "speedtest"
packagelist "rsync" "openssh-client"
package "sss"
package "synaptic"
package "terminator"
package "tree"
package "vim"
package "xclip"
package "zoom"
package "zoxide"

flatpak remote-add --if-not-exists "flathub" "https://flathub.org/repo/flathub.flatpakrepo"
